<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Black & Green Theme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <style>
        @font-face {
            font-family: 'CustomFont';
            src: url('./font.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        body {
            font-family: 'CustomFont', sans-serif !important;
            background: #000000;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .admin-container {
            max-width: 600px;
            width: 90%;
            background: rgba(26, 26, 26, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
        }
        .error-message {
            display: none;
            color: #f87171;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }
        .success-message {
            display: none;
            color: #34d399;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }
        input, textarea, button, select, h1, h2, label, p, strong {
            font-family: 'CustomFont', sans-serif !important;
        }
        .toggle-label {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            color: #34d399;
        }
        .toggle-checkbox {
            display: none;
        }
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: #4b5563;
            border-radius: 9999px;
            transition: background 0.3s ease;
            margin-left: 8px;
        }
        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        .toggle-checkbox:checked + .toggle-switch {
            background: #34d399;
        }
        .toggle-checkbox:checked + .toggle-switch::before {
            transform: translateX(20px);
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <h1 class="text-3xl font-semibold text-center mb-4 text-gray-200" id="greeting">Welcome Admin</h1>
        
        <!-- Login Form -->
        <div id="loginForm" class="space-y-6">
            <div>
                <label class="block text-gray-200 font-semibold mb-2" for="adminEmail">Admin Email</label>
                <input
                    type="email"
                    id="adminEmail"
                    class="w-full px-4 py-3 rounded-xl border border-gray-600 bg-gray-800 placeholder-gray-400 focus:outline-none focus:ring-4 focus:ring-green-400 focus:border-green-400 text-gray-200 font-semibold"
                    placeholder="Enter admin email"
                    required
                >
            </div>
            <div>
                <label class="block text-gray-200 font-semibold mb-2" for="adminPassword">Admin Password</label>
                <input
                    type="password"
                    id="adminPassword"
                    class="w-full px-4 py-3 rounded-xl border border-gray-600 bg-gray-800 placeholder-gray-400 focus:outline-none focus:ring-4 focus:ring-green-400 focus:border-green-400 text-gray-200 font-semibold"
                    placeholder="Enter admin password"
                    required
                >
            </div>
            <button
                type="button"
                id="loginBtn"
                class="w-full bg-green-400 hover:bg-green-500 text-gray-900 font-semibold py-3 rounded-xl shadow-lg"
            >
                Login
            </button>
            <p id="loginError" class="error-message">Incorrect email or password!</p>
        </div>

        <!-- Code Management Form -->
        <div id="codeManagement" class="space-y-6 hidden">
            <div>
                <label class="block text-gray-200 font-semibold mb-2" for="newCode">4-Digit Code</label>
                <input
                    type="text"
                    id="newCode"
                    maxlength="4"
                    pattern="\d{4}"
                    inputmode="numeric"
                    class="w-full px-4 py-3 rounded-xl border border-gray-600 bg-gray-800 placeholder-gray-400 focus:outline-none focus:ring-4 focus:ring-green-400 focus:border-green-400 text-gray-200 font-semibold"
                    placeholder="e.g. 1234"
                    required
                >
            </div>
            <div>
                <label class="block text-gray-200 font-semibold mb-2" for="popupMessage">Popup Message</label>
                <textarea
                    id="popupMessage"
                    class="w-full px-4 py-3 rounded-xl border border-gray-600 bg-gray-800 placeholder-gray-400 focus:outline-none focus:ring-4 focus:ring-green-400 focus:border-green-400 text-gray-200 font-semibold"
                    rows="4"
                    placeholder="Enter popup message"
                    required
                ></textarea>
            </div>
            <div>
                <label class="block text-gray-200 font-semibold mb-2" for="amountInput">Amount Paid (₹)</label>
                <input
                    type="number"
                    id="amountInput"
                    min="0"
                    step="1"
                    class="w-full px-4 py-3 rounded-xl border border-gray-600 bg-gray-800 placeholder-gray-400 focus:outline-none focus:ring-4 focus:ring-green-400 focus:border-green-400 text-gray-200 font-semibold"
                    placeholder="e.g. 500"
                    required
                >
            </div>
            <div>
                <label class="block text-gray-200 font-semibold mb-2" for="refundableInput">Refundable Amount (₹)</label>
                <input
                    type="number"
                    id="refundableInput"
                    min="0"
                    step="1"
                    class="w-full px-4 py-3 rounded-xl border border-gray-600 bg-gray-800 placeholder-gray-400 focus:outline-none focus:ring-4 focus:ring-green-400 focus:border-green-400 text-gray-200 font-semibold"
                    placeholder="e.g. 100"
                    required
                >
            </div>
            <div>
                <label class="block text-gray-200 font-semibold mb-2" for="redirectPage">Redirect Page</label>
                <select
                    id="redirectPage"
                    class="w-full px-4 py-3 rounded-xl border border-gray-600 bg-gray-800 text-gray-200 focus:outline-none focus:ring-4 focus:ring-green-400 focus:border-green-400 font-semibold"
                >
                    <option value="none">No Redirect</option>
                    <option value="show.html">Show.html</option>
                    <option value="album.html">Album.html</option>
                </select>
            </div>
            <div>
                <label class="toggle-label">
                    Enable Code
                    <input type="checkbox" id="enableCode" class="toggle-checkbox">
                    <span class="toggle-switch"></span>
                </label>
            </div>
            <button
                type="button"
                id="addCodeBtn"
                class="w-full bg-green-400 hover:bg-green-500 text-gray-900 font-semibold py-3 rounded-xl shadow-lg"
            >
                Add Code
            </button>
            <p id="codeError" class="error-message">Please enter a valid 4-digit code, message, and non-negative amounts!</p>
            <p id="codeSuccess" class="success-message">Code added successfully!</p>

            <!-- Special Code 1104 Management -->
            <div class="mt-6">
                <h2 class="text-xl font-semibold text-gray-200 mb-4">Special Code (1104)</h2>
                <div id="specialCodeForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-200 font-semibold mb-2" for="specialPopupMessage">Popup Message</label>
                        <textarea
                            id="specialPopupMessage"
                            class="w-full px-4 py-3 rounded-xl border border-gray-600 bg-gray-800 placeholder-gray-400 focus:outline-none focus:ring-4 focus:ring-green-400 focus:border-green-400 text-gray-200 font-semibold"
                            rows="4"
                            placeholder="Enter popup message for code 1104"
                            required
                        ></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-200 font-semibold mb-2" for="specialAmountInput">Amount Paid (₹)</label>
                        <input
                            type="number"
                            id="specialAmountInput"
                            min="0"
                            step="1"
                            class="w-full px-4 py-3 rounded-xl border border-gray-600 bg-gray-800 placeholder-gray-400 focus:outline-none focus:ring-4 focus:ring-green-400 focus:border-green-400 text-gray-200 font-semibold"
                            placeholder="e.g. 500"
                            required
                        >
                    </div>
                    <div>
                        <label class="block text-gray-200 font-semibold mb-2" for="specialRefundableInput">Refundable Amount (₹)</label>
                        <input
                            type="number"
                            id="specialRefundableInput"
                            min="0"
                            step="1"
                            class="w-full px-4 py-3 rounded-xl border border-gray-600 bg-gray-800 placeholder-gray-400 focus:outline-none focus:ring-4 focus:ring-green-400 focus:border-green-400 text-gray-200 font-semibold"
                            placeholder="e.g. 100"
                            required
                        >
                    </div>
                    <div>
                        <label class="block text-gray-200 font-semibold mb-2" for="specialRedirectPage">Redirect Page</label>
                        <select
                            id="specialRedirectPage"
                            class="w-full px-4 py-3 rounded-xl border border-gray-600 bg-gray-800 text-gray-200 focus:outline-none focus:ring-4 focus:ring-green-400 focus:border-green-400 font-semibold"
                        >
                            <option value="none">No Redirect</option>
                            <option value="show.html">Show.html</option>
                            <option value="album.html">Album.html</option>
                        </select>
                    </div>
                    <div>
                        <label class="toggle-label">
                            Enable Code
                            <input type="checkbox" id="specialEnableCode" class="toggle-checkbox">
                            <span class="toggle-switch"></span>
                        </label>
                    </div>
                    <button
                        type="button"
                        id="updateSpecialCodeBtn"
                        class="w-full bg-green-400 hover:bg-green-500 text-gray-900 font-semibold py-3 rounded-xl shadow-lg"
                    >
                        Update Special Code
                    </button>
                    <p id="specialCodeError" class="error-message">Please enter a valid message and non-negative amounts!</p>
                    <p id="specialCodeSuccess" class="success-message">Special code updated successfully!</p>
                </div>
            </div>
            
            <!-- Code List -->
            <div class="mt-6">
                <h2 class="text-xl font-semibold text-gray-200 mb-4">Your Codes</h2>
                <ul id="codeList" class="space-y-4"></ul>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCRKoruLajxOkuuKW5iMieidfEdAjw_Kcg",
            authDomain: "videocall-2739a.firebaseapp.com",
            databaseURL: "https://videocall-2739a-default-rtdb.firebaseio.com",
            projectId: "videocall-2739a",
            storageBucket: "videocall-2739a.firebasestorage.app",
            messagingSenderId: "369059717819",
            appId: "1:369059717819:web:826492ecfe287193edbf9e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        const loginForm = document.getElementById('loginForm');
        const codeManagement = document.getElementById('codeManagement');
        const loginBtn = document.getElementById('loginBtn');
        const adminEmail = document.getElementById('adminEmail');
        const adminPassword = document.getElementById('adminPassword');
        const loginError = document.getElementById('loginError');
        const addCodeBtn = document.getElementById('addCodeBtn');
        const newCode = document.getElementById('newCode');
        const popupMessageInput = document.getElementById('popupMessage');
        const amountInput = document.getElementById('amountInput');
        const refundableInput = document.getElementById('refundableInput');
        const redirectPage = document.getElementById('redirectPage');
        const enableCode = document.getElementById('enableCode');
        const codeError = document.getElementById('codeError');
        const codeSuccess = document.getElementById('codeSuccess');
        const codeList = document.getElementById('codeList');
        const greeting = document.getElementById('greeting');
        const updateSpecialCodeBtn = document.getElementById('updateSpecialCodeBtn');
        const specialPopupMessage = document.getElementById('specialPopupMessage');
        const specialAmountInput = document.getElementById('specialAmountInput');
        const specialRefundableInput = document.getElementById('specialRefundableInput');
        const specialRedirectPage = document.getElementById('specialRedirectPage');
        const specialEnableCode = document.getElementById('specialEnableCode');
        const specialCodeError = document.getElementById('specialCodeError');
        const specialCodeSuccess = document.getElementById('specialCodeSuccess');

        // Dynamic greeting based on time
        function setGreeting() {
            const hour = new Date().getHours();
            let timeOfDay;
            if (hour < 12) {
                timeOfDay = "Good Morning";
            } else if (hour < 17) {
                timeOfDay = "Good Afternoon";
            } else {
                timeOfDay = "Good Evening";
            }
            greeting.textContent = `${timeOfDay}, Admin`;
        }
        setGreeting();

        // Check auth state
        auth.onAuthStateChanged((user) => {
            if (user) {
                loginForm.classList.add('hidden');
                codeManagement.classList.remove('hidden');
                setGreeting();
                loadCodes(user.uid);
                loadSpecialCode();
            } else {
                loginForm.classList.remove('hidden');
                codeManagement.classList.add('hidden');
            }
        });

        loginBtn.addEventListener('click', () => {
            const email = adminEmail.value.trim();
            const password = adminPassword.value.trim();

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    loginError.style.display = 'none';
                })
                .catch((error) => {
                    console.error("Login error:", error);
                    loginError.style.display = 'block';
                    loginError.textContent = 'Incorrect email or password!';
                });
        });

        addCodeBtn.addEventListener('click', () => {
            const code = newCode.value.trim();
            const message = popupMessageInput.value.trim();
            const amount = parseInt(amountInput.value.trim());
            const refundable = parseInt(refundableInput.value.trim());
            const redirect = redirectPage.value;
            const enabled = enableCode.checked;

            if (!/^\d{4}$/.test(code) || message.length === 0 || isNaN(amount) || amount < 0 || isNaN(refundable) || refundable < 0) {
                codeError.style.display = 'block';
                codeError.textContent = 'Please enter a valid 4-digit code, message, and non-negative amounts!';
                codeSuccess.style.display = 'none';
                return;
            }

            if (code === "1104") {
                codeError.style.display = 'block';
                codeError.textContent = 'Code 1104 is reserved for special use!';
                codeSuccess.style.display = 'none';
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                codeError.style.display = 'block';
                codeError.textContent = 'You must be logged in!';
                codeSuccess.style.display = 'none';
                return;
            }

            // Check if code exists for this admin
            database.ref(`admin_codes/${user.uid}/${code}`).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    codeError.style.display = 'block';
                    codeError.textContent = 'Code already exists!';
                    codeSuccess.style.display = 'none';
                    return;
                }

                const newCodeData = {
                    code,
                    message,
                    icon: message.toLowerCase().includes('thank') ? 'heart' : 'exclamation-circle',
                    amount,
                    refundable,
                    redirect,
                    enabled
                };

                database.ref(`admin_codes/${user.uid}/${code}`).set(newCodeData)
                    .then(() => {
                        newCode.value = '';
                        popupMessageInput.value = '';
                        amountInput.value = '';
                        refundableInput.value = '';
                        redirectPage.value = 'none';
                        enableCode.checked = false;
                        codeError.style.display = 'none';
                        codeSuccess.style.display = 'block';
                        loadCodes(user.uid);
                    })
                    .catch((error) => {
                        console.error("Error adding code:", error);
                        codeError.style.display = 'block';
                        codeError.textContent = 'Error saving code!';
                    });
            });
        });

        updateSpecialCodeBtn.addEventListener('click', () => {
            const message = specialPopupMessage.value.trim();
            const amount = parseInt(specialAmountInput.value.trim());
            const refundable = parseInt(specialRefundableInput.value.trim());
            const redirect = specialRedirectPage.value;
            const enabled = specialEnableCode.checked;

            if (message.length === 0 || isNaN(amount) || amount < 0 || isNaN(refundable) || refundable < 0) {
                specialCodeError.style.display = 'block';
                specialCodeError.textContent = 'Please enter a valid message and non-negative amounts!';
                specialCodeSuccess.style.display = 'none';
                return;
            }

            const specialCodeData = {
                code: "1104",
                message,
                icon: message.toLowerCase().includes('thank') ? 'heart' : 'exclamation-circle',
                amount,
                refundable,
                redirect,
                enabled
            };

            database.ref('special_codes/1104').set(specialCodeData)
                .then(() => {
                    specialPopupMessage.value = '';
                    specialAmountInput.value = '';
                    specialRefundableInput.value = '';
                    specialRedirectPage.value = 'none';
                    specialEnableCode.checked = false;
                    specialCodeError.style.display = 'none';
                    specialCodeSuccess.style.display = 'block';
                    loadSpecialCode();
                })
                .catch((error) => {
                    console.error("Error updating special code:", error);
                    specialCodeError.style.display = 'block';
                    specialCodeError.textContent = 'Error saving special code!';
                });
        });
        
        function loadCodes(uid) {
            console.log("Loading codes for admin:", uid);
            database.ref(`admin_codes/${uid}`).once('value').then((snapshot) => {
                const codes = [];
                snapshot.forEach((childSnapshot) => {
                    codes.push(childSnapshot.val());
                });
                renderCodeList(codes);
            }).catch((error) => {
                console.error("Error loading codes:", error);
                codeError.style.display = 'block';
                codeError.textContent = 'Error loading codes!';
            });
        }

        function loadSpecialCode() {
            database.ref('special_codes/1104').once('value').then((snapshot) => {
                const specialCode = snapshot.val();
                if (specialCode) {
                    specialPopupMessage.value = specialCode.message || '';
                    specialAmountInput.value = specialCode.amount || '';
                    specialRefundableInput.value = specialCode.refundable || '';
                    specialRedirectPage.value = specialCode.redirect || 'none';
                    specialEnableCode.checked = specialCode.enabled || false;
                }
            }).catch((error) => {
                console.error("Error loading special code:", error);
                specialCodeError.style.display = 'block';
                specialCodeError.textContent = 'Error loading special code!';
            });
        }

        function renderCodeList(codes) {
            console.log("Rendering code list:", codes);
            codeList.innerHTML = '';
            codes.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'bg-gray-800 p-4 rounded-xl text-gray-200';
                li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <strong>Code:</strong> ${item.code}<br>
                            <strong>Message:</strong> ${item.message}<br>
                            <strong>Amount:</strong> ₹ ${item.amount}<br>
                            <strong>Refundable:</strong> ₹ ${item.refundable || 0}<br>
                            <strong>Redirect:</strong> ${item.redirect || 'None'}<br>
                            <strong>Enabled:</strong> ${item.enabled ? 'Yes' : 'No'}
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="toggle-label">
                                <input type="checkbox" class="toggle-checkbox" ${item.enabled ? 'checked' : ''} onchange="toggleCodeStatus('${item.code}', this.checked)">
                                <span class="toggle-switch"></span>
                            </label>
                            <button
                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg"
                                onclick="deleteCode('${item.code}')"
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                `;
                codeList.appendChild(li);
            });
        }

        window.toggleCodeStatus = function(code, isEnabled) {
            const user = auth.currentUser;
            if (!user) {
                codeError.style.display = 'block';
                codeError.textContent = 'You must be logged in!';
                return;
            }
            database.ref(`admin_codes/${user.uid}/${code}`).update({ enabled: isEnabled })
                .then(() => {
                    console.log(`Code ${code} enabled status updated to ${isEnabled}`);
                    loadCodes(user.uid);
                })
                .catch((error) => {
                    console.error("Error updating code status:", error);
                    codeError.style.display = 'block';
                    codeError.textContent = 'Error updating code status!';
                });
        };

        window.deleteCode = function(code) {
            const user = auth.currentUser;
            if (!user) {
                codeError.style.display = 'block';
                codeError.textContent = 'You must be logged in!';
                return;
            }
            database.ref(`admin_codes/${user.uid}/${code}`).remove()
                .then(() => {
                    console.log("Code deleted:", code);
                    loadCodes(user.uid);
                })
                .catch((error) => {
                    console.error("Error deleting code:", error);
                    codeError.style.display = 'block';
                    codeError.textContent = 'Error deleting code!';
                });
        };
    </script>
</body>
</html>