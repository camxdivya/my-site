<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call Invitation - Dark Mode iOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        @font-face {
            font-family: 'CustomFont';
            src: url('./font.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        body {
            font-family: 'CustomFont', sans-serif !important;
            background: #1c2526;
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }
        .container {
            background: rgba(28, 37, 38, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            padding: 2rem;
            width: 100%;
            max-width: 450px;
            min-height: calc(100vh - 4rem);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            margin: 2rem;
            box-sizing: border-box;
        }
        h1, label, span, button, input, a {
            font-family: 'CustomFont', sans-serif !important;
        }
        h1 {
            color: #ffffff;
            font-size: clamp(1.5rem, 5vw, 2rem);
            font-weight: 600;
            text-align: center;
            margin-bottom: 2rem;
        }
        .profile-pics {
            display: flex;
            justify-content: center;
            gap: clamp(1rem, 5vw, 2rem);
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .profile-initial {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(1.5rem, 4vw, 2rem);
            font-weight: 600;
            color: #fff;
            background: linear-gradient(45deg, #007aff, #5856d6);
            border-radius: 50%;
            width: clamp(60px, 15vw, 80px);
            height: clamp(60px, 15vw, 80px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .code-inputs {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .code-input {
            width: clamp(40px, 10vw, 50px);
            height: clamp(50px, 12vw, 60px);
            text-align: center;
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            font-weight: 600;
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .code-input:focus {
            border-color: #007aff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.4);
        }
        .name-input {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .name-input:focus {
            border-color: #007aff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.4);
        }
        .join-button {
            position: relative;
            width: 100%;
            background: #007aff;
            color: #fff;
            font-size: clamp(1rem, 4vw, 1.1rem);
            font-weight: 600;
            padding: 0.9rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .join-button:hover {
            background: #005bb5;
        }
        .join-button.loading .button-text {
            opacity: 0;
        }
        .join-button .spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: clamp(24px, 6vw, 30px);
            height: clamp(24px, 6vw, 30px);
            border: 4px solid transparent;
            border-top: 4px solid #34d399;
            border-right: 4px solid #007aff;
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite, pulse 1.5s ease-in-out infinite;
        }
        .join-button.loading .spinner {
            display: block;
        }
        .join-button .success-check,
        .join-button .failed-check {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: clamp(24px, 6vw, 30px);
            animation: popIn 0.5s ease forwards, pulse 1s ease-in-out infinite;
        }
        .join-button.success .success-check {
            display: block;
            color: #34d399;
        }
        .join-button.failed .failed-check {
            display: block;
            color: #f87171;
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .buy-codes {
            display: block;
            text-align: center;
            color: #007aff;
            font-weight: 600;
            margin-top: 1rem;
            text-decoration: none;
            font-size: clamp(0.9rem, 3.5vw, 1rem);
        }
        .copyright {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: clamp(0.75rem, 3vw, 0.85rem);
            margin-top: 2rem;
        }
        .popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .popup-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .popup-box {
            background: rgba(28, 37, 38, 0.95);
            border-radius: 20px;
            padding: 1.5rem;
            max-width: 320px;
            width: 90%;
            text-align: center;
            transform: translateY(50px);
            opacity: 0;
            animation: slideIn 0.3s ease forwards;
        }
        @keyframes slideIn {
            to { transform: translateY(0); opacity: 1; }
        }
        .popup-icon {
            font-size: 3rem;
            color: #007aff;
            margin-bottom: 1rem;
            animation: pulse 1s ease-in-out infinite;
        }
        .popup-message {
            font-size: clamp(1rem, 3.5vw, 1.1rem);
            color: #ffffff;
            margin-bottom: 1.5rem;
        }
        .popup-close-btn {
            background: #007aff;
            color: #fff;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .popup-close-btn:hover {
            background: #005bb5;
        }
        .amount-container {
            display: flex;
            gap: clamp(1rem, 3vw, 1.5rem);
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        .amount-box {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 0.75rem;
            color: #ffffff;
            font-size: clamp(0.8rem, 2.5vw, 0.9rem);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, ))^.3);
        }
        .amount-box.paid {
            background: #34d399;
            color: #1f2937;
        }
        .amount-box.refunded {
            background: #f87171;
            color: #1f2937;
        }
        .amount-box i {
            font-size: clamp(0.9rem, 3vw, 1rem);
        }
        @media (max-width: 480px) {
            .container {
                margin: 1rem;
                padding: 1.5rem;
                min-height: calc(100vh - 2rem);
            }
            .code-input {
                width: clamp(35px, 12vw, 45px);
                height: clamp(45px, 12vw, 55px);
            }
            .amount-box {
                padding: 0.5rem;
                font-size: clamp(0.7rem, 2vw, 0.8rem);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div>
            <h1>Join Your Video Date</h1>
            <div class="profile-pics">
                <div class="flex flex-col items-center">
                    <img alt="Profile picture of first user Divya Das" class="rounded-full w-[clamp(60px,15vw,80px)] h-[clamp(60px,15vw,80px)] object-cover shadow-md" src="profile.jpg"/>
                    <span class="mt-2 text-white font-semibold">Divya Das</span>
                    <p class="text-red-500 text-sm mt-1 flex items-center space-x-1">
                        <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                        <span>Live Now</span>
                    </p>
                </div>
                <div class="flex flex-col items-center">
                    <div class="profile-initial" id="profile2Container"></div>
                    <span class="mt-2 text-white font-semibold" id="profile2Name">User 2</span>
                    <span class="mt-1 text-blue-500 text-sm" id="amountPaid">Amount Paid: ₹ 0</span>
                </div>
            </div>
            <form id="joinForm" class="space-y-6" novalidate>
                <div>
                    <label class="block text-white font-semibold mb-2" for="nameInput">Enter Your Name</label>
                    <input
                        autocomplete="off"
                        class="w-full px-4 py-3 rounded-xl name-input focus:outline-none text-white"
                        id="nameInput"
                        maxlength="30"
                        name="name"
                        placeholder="Your name"
                        required
                        type="text"
                    />
                </div>
                 <div>
                    <label class="block text-white font-semibold mb-2">Enter 4-digit Code</label>
                    <div class="code-inputs">
                        <input class="code-input" type="text" maxlength="1" inputmode="numeric" pattern="\d" required>
                        <input class="code-input" type="text" maxlength="1" inputmode="numeric" pattern="\d" required>
                        <input class="code-input" type="text" maxlength="1" inputmode="numeric" pattern="\d" required>
                        <input class="code-input" type="text" maxlength="1" inputmode="numeric" pattern="\d" required>
                    </div>
                </div>
                <button class="join-button" type="submit">
                    <span class="button-text">Join Call</span>
                    <div class="spinner"></div>
                    <i class="fas fa-check-circle success-check"></i>
                    <i class="fas fa-times-circle failed-check"></i>
                </button>
            </form>
            <a class="buy-codes" href="https://example.com/buy-codes" target="_blank" rel="noopener noreferrer">Buy Codes</a>
        </div>
        <div class="copyright">
            &copy; 2025 Video Call App. All rights reserved.
        </div>
    </div>
    <div class="popup-overlay" id="popupOverlay" role="dialog" aria-labelledby="popupTitle" aria-describedby="popupDesc">
        <div class="popup-box" role="document">
            <div class="popup-icon" id="popupIcon"></div>
            <div class="popup-message" id="popupMessage"></div>
            <div class="amount-container" id="popupAmounts">
                <div class="amount-box paid">
                    <i class="fas fa-check-circle"></i>
                    <span>Paid: ₹ <span id="popupAmountPaid">0</span></span>
                </div>
                <div class="amount-box refunded">
                    <i class="fas fa-undo"></i>
                    <span>Refundable: ₹ <span id="popupAmountRefundable">0</span></span>
                </div>
            </div>
            <button class="popup-close-btn" id="popupCloseBtn" type="button">Close</button>
        </div>
    </div>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCRKoruLajxOkuuKW5iMieidfEdAjw_Kcg",
            authDomain: "videocall-2739a.firebaseapp.com",
            databaseURL: "https://videocall-2739a-default-rtdb.firebaseio.com",
            projectId: "videocall-2739a",
            storageBucket: "videocall-2739a.firebasestorage.app",
            messagingSenderId: "369059717819",
            appId: "1:369059717819:web:826492ecfe287193edbf9e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const nameInput = document.getElementById("nameInput");
        const profile2Container = document.getElementById("profile2Container");
        const profile2Name = document.getElementById("profile2Name");
        const amountPaid = document.getElementById("amountPaid");
        const joinForm = document.getElementById("joinForm");
        const codeInputs = document.querySelectorAll(".code-input");
        const joinButton = document.querySelector(".join-button");
        const popupOverlay = document.getElementById("popupOverlay");
        const popupMessage = document.getElementById("popupMessage");
        const popupIcon = document.getElementById("popupIcon");
        const popupCloseBtn = document.getElementById("popupCloseBtn");
        const popupAmountPaid = document.getElementById("popupAmountPaid");
        const popupAmountRefundable = document.getElementById("popupAmountRefundable");

        function detectMobileOS() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) return "iOS";
            if (/android/i.test(userAgent)) return "Android";
            return "Other";
        }

        // Handle name input and profile initial
        nameInput.addEventListener("input", () => {
            const name = nameInput.value.trim();
            if (name.length > 0) {
                const initial = name[0].toUpperCase();
                profile2Container.textContent = initial;
                profile2Name.textContent = name;
            } else {
                profile2Container.textContent = "";
                profile2Name.textContent = "User 2";
                amountPaid.textContent = "Amount Paid: ₹ 0";
            }
        });

        // Handle box-by-box code input
        codeInputs.forEach((input, index) => {
            input.addEventListener("input", (e) => {
                if (e.target.value.length === 1 && index < codeInputs.length - 1) {
                    codeInputs[index + 1].focus();
                }
                if (e.target.value.length === 0 && index > 0) {
                    codeInputs[index - 1].focus();
                }
            });
            input.addEventListener("keydown", (e) => {
                if (e.key === "Backspace" && !input.value && index > 0) {
                    codeInputs[index - 1].focus();
                }
            });
        });

        function showPopup(message, icon = "exclamation-circle", amount = 0, refundable = 0, callback = null) {
            popupMessage.textContent = message;
            popupIcon.innerHTML = `<i class="fas fa-${icon}"></i>`;
            popupAmountPaid.textContent = amount;
            popupAmountRefundable.textContent = refundable;
            popupOverlay.classList.add("active");
            popupCloseBtn.focus();
            if (callback) {
                popupCloseBtn.addEventListener("click", callback, { once: true });
            }
        }

        function closePopup() {
            popupOverlay.classList.remove("active");
        }

        popupCloseBtn.addEventListener("click", closePopup);
        popupOverlay.addEventListener("click", (e) => {
            if (e.target === popupOverlay) closePopup();
        });

        document.addEventListener("keydown", (e) => {
            if (!popupOverlay.classList.contains("active")) return;
            if (e.key === "Escape") closePopup();
        });

        joinForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const code = Array.from(codeInputs).map(input => input.value).join("");
            const name = nameInput.value.trim();

            if (code.length !== 4 || !/^\d{4}$/.test(code)) {
                joinButton.classList.add("loading");
                setTimeout(() => {
                    joinButton.classList.remove("loading");
                    joinButton.classList.add("failed");
                    setTimeout(() => {
                        joinButton.classList.remove("failed");
                        showPopup("Please enter a valid 4-digit code", "exclamation-circle", 0, 0);
                        joinButton.disabled = false;
                    }, 500);
                }, 1500);
                return;
            }
            if (name.length === 0) {
                joinButton.classList.add("loading");
                setTimeout(() => {
                    joinButton.classList.remove("loading");
                    joinButton.classList.add("failed");
                    setTimeout(() => {
                        joinButton.classList.remove("failed");
                        showPopup("Please enter your name", "exclamation-circle", 0, 0);
                        joinButton.disabled = false;
                    }, 500);
                }, 1500);
                return;
            }

            // Show loading animation
            joinButton.classList.add("loading");
            joinButton.disabled = true;

            setTimeout(() => {
                // Check for special code 1104 in special_codes
                database.ref('special_codes/1104').once('value', (snapshot) => {
                    const specialCode = snapshot.val();
                    if (code === "1104" && specialCode) {
                        joinButton.classList.remove("loading");
                        const isEnabled = specialCode.enabled;
                        joinButton.classList.add(isEnabled ? "success" : "failed");
                        setTimeout(() => {
                            joinButton.classList.remove(isEnabled ? "success" : "failed");
                            amountPaid.textContent = `Amount Paid: ₹ ${specialCode.amount || 0}`;
                            const redirectCallback = isEnabled && specialCode.redirect && specialCode.redirect !== 'none'
                                ? () => {
                                      window.location.href = `${specialCode.redirect}?code=${code}&name=${encodeURIComponent(name)}`;
                                  }
                                : null;
                            showPopup(
                                specialCode.message,
                                specialCode.icon || "exclamation-circle",
                                specialCode.amount || 0,
                                specialCode.refundable || 0,
                                redirectCallback
                            );
                            joinButton.disabled = false;
                        }, 500);
                    } else {
                        // Check all admin codes
                        database.ref('admin_codes').once('value', (snapshot) => {
                            let matchedCode = null;
                            snapshot.forEach((adminSnapshot) => {
                                const adminCodes = adminSnapshot.val();
                                if (adminCodes && adminCodes[code]) {
                                    matchedCode = adminCodes[code];
                                }
                            });

                            joinButton.classList.remove("loading");
                            if (!matchedCode) {
                                joinButton.classList.add("failed");
                                setTimeout(() => {
                                    joinButton.classList.remove("failed");
                                    showPopup("Incorrect Code", "exclamation-circle", 0, 0);
                                    amountPaid.textContent = "Amount Paid: ₹ 0";
                                    joinButton.disabled = false;
                                }, 500);
                            } else {
                                const isEnabled = matchedCode.enabled;
                                joinButton.classList.add(isEnabled ? "success" : "failed");
                                setTimeout(() => {
                                    joinButton.classList.remove(isEnabled ? "success" : "failed");
                                    amountPaid.textContent = `Amount Paid: ₹ ${matchedCode.amount || 0}`;
                                    const redirectCallback = isEnabled && matchedCode.redirect && matchedCode.redirect !== 'none'
                                        ? () => {
                                              window.location.href = `${matchedCode.redirect}?code=${code}&name=${encodeURIComponent(name)}`;
                                          }
                                        : null;
                                    showPopup(
                                        matchedCode.message,
                                        matchedCode.icon || "exclamation-circle",
                                        matchedCode.amount || 0,
                                        matchedCode.refundable || 0,
                                        redirectCallback
                                    );
                                    joinButton.disabled = false;
                                }, 500);
                            }
                        }, (error) => {
                            console.error("Error fetching code:", error);
                            joinButton.classList.remove("loading");
                            joinButton.classList.add("failed");
                            setTimeout(() => {
                                joinButton.classList.remove("failed");
                                showPopup("Error fetching code. Please try again.", "exclamation-circle", 0, 0);
                                amountPaid.textContent = "Amount Paid: ₹ 0";
                                joinButton.disabled = false;
                            }, 500);
                        });
                    }
                }, (error) => {
                    console.error("Error fetching special code:", error);
                    joinButton.classList.remove("loading");
                    joinButton.classList.add("failed");
                    setTimeout(() => {
                        joinButton.classList.remove("failed");
                        showPopup("Error fetching code. Please try again.", "exclamation-circle", 0, 0);
                        amountPaid.textContent = "Amount Paid: ₹ 0";
                        joinButton.disabled = false;
                    }, 500);
                });
            }, 1500); // Simulate verification delay
        });
    </script>
</body>
</html>